<!DOCTYPE html>
<html><head>
<style type="text/css">
html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; }
</style>
<script src="https://maps.google.com/maps/api/js?v=3&amp;sensor=false" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript"><!--
var map;
var marker;
function init_google_maps() {
  google.maps.controlStyle = 'azteca';
  var opts = { zoom: 4, center: { lat:35.680725, lng:139.767293 } }; // dummy
  map = new google.maps.Map(document.getElementById('map'), opts);
  if(!map) { alert("!map"); }
  map.addListener('click',    function(event) { jump_to(event.latLng.lat(), event.latLng.lng(), false); } );
  //map.addListener('dblclick', function(event) { jump_to(event.latLng.lat(), event.latLng.lng(), true); } );
  map.addListener('zoom_changed', func_on_changed);
  //map.addListener('center_changed', func_on_changed);
  marker = new google.maps.Marker({
    position: opts['center'],
    map: map,
    title: "go to google maps",
  });
  marker.addListener('click', function(event) {
    location.assign("https://maps.google.com/maps?q=" + round_latlng(marker.getPosition().lat()) + "," + round_latlng(marker.getPosition().lng()));
  });
  var re_latlng = /^\#? *([-+]?[0-9]+(?:\.[0-9]*)?) *, *([-+]?[0-9]+(?:\.[0-9]*)?) *, *([0-9]+) */;
  var match = re_latlng.exec(location.hash);
  if(match) {
    jump_to(match[1], match[2], true);
    map.setZoom(Number(match[3]));
  }
  else {
    if(!navigator.geolocation) alert("Geolocationが使えません");
    else {
      navigator.geolocation.getCurrentPosition(
        function(pos) {
          jump_to(pos.coords.latitude, pos.coords.longitude, true);
          map.setZoom(15);
        },
        function(error) {
          switch(error.code) {
            case error.POSTION_UNAVAILABLE: alert("位置情報取得が不可能"); break;
            case error.PERMISSINO_DENIED: alert("位置情報取得が不許可"); break;
            case error.PERMISSION_DENIED_TIMEOUT: alert("位置情報取得タイムアウト"); break;
            default:alert("よくわからないエラーです");
          }
        }
      )
    }
  }
}
function jump_to(lat, lng, pan) {
  var latlng = new google.maps.LatLng(lat, lng);
  marker.setPosition(latlng);
  if(pan) map.panTo(latlng);
  func_on_changed();
}
function round_latlng(value) {
   return Math.round(value * 1e7) / 1e7;
}
function func_on_changed() {
  location.hash = "#" + round_latlng(marker.getPosition().lat()) + "," + round_latlng(marker.getPosition().lng()) + "," + map.getZoom()
}
//--></script>
</head>
<body onLoad="init_google_maps();"><div id="map"></div></body>
</html>
